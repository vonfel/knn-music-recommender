<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>k-NN Music Recommender - Interactive Demo</title>
    <style>
        /* --- Base & Variables --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #1DB954; --secondary-color: #1ed760; --text-dark: #191414;
            --text-light: #b3b3b3; --bg-white: #ffffff; --bg-dark: #121212;
            --bg-card: #282828; --success-color: #1DB954; --error-color: #f15e6c;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-dark); color: white; line-height: 1.6; padding-bottom: 100px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* --- Navigation & Header --- */
        .navbar { background: #191414; box-shadow: 0 2px 4px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 100; margin: -20px -20px 0 -20px; }
        .navbar-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .navbar-brand { font-size: 1.3em; font-weight: 600; color: var(--primary-color); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .navbar-links { display: flex; gap: 30px; align-items: center; }
        .navbar-links a { color: var(--text-light); text-decoration: none; font-weight: 500; transition: color 0.2s; }
        .navbar-links a:hover { color: white; }
        .header { text-align: center; padding: 60px 0 40px; background: #191414; margin-bottom: 40px; }
        .header h1 { font-size: 3em; font-weight: 700; margin-bottom: 10px; color: white; }
        .header p { font-size: 1.2em; color: var(--text-light); }
        
        /* --- Sections & Cards --- */
        .intro-section, .section { background: #181818; border-radius: 8px; padding: 30px; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .intro-section h3 { margin-bottom: 15px; font-size: 1.8em; font-weight: 500; display: flex; align-items: center; gap: 12px;}
        .intro-section p { color: rgba(255,255,255,0.8); margin-bottom: 10px; line-height: 1.8; }
        .intro-section strong { color: var(--primary-color); font-weight: 500; }
        .section-title { font-size: 1.5em; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 24px; background: var(--primary-color); border-radius: 2px; }
        
        /* --- Tooltips --- */
        .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: rgba(255,255,255,0.1); border-radius: 50%; font-size: 14px; cursor: help; position: relative; color: var(--primary-color); font-weight: bold; }
        .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px); background: #191414; padding: 12px 16px; border-radius: 8px; font-size: 14px; width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; pointer-events: none; line-height: 1.5; }
        .info-icon:hover .tooltip { opacity: 1; visibility: visible; }
        .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #191414; }
        
        /* --- Featured Music Grid (Start Exploring) --- */
        .featured-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .music-card { position: relative; border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; background: var(--bg-card); color: white; }
        .music-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .music-card-image { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
        .music-card-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; padding: 20px 15px 15px; transform: translateY(100%); transition: transform 0.3s; }
        .music-card:hover .music-card-overlay { transform: translateY(0); }
        .music-card-title { font-weight: 600; font-size: 1.1em; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .music-card-artist { font-size: 0.9em; opacity: 0.8; }
        .play-button { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(29, 185, 84, 0.85); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; opacity: 0; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .music-card:hover .play-button { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        
        /* --- Search & Results --- */
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 12px 20px; border: 1px solid #535353; border-radius: 500px; font-size: 16px; background: #333; color: white; transition: all 0.2s; }
        .search-input::placeholder { color: var(--text-light); }
        .search-input:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-color); background: #535353; border-color: var(--primary-color); }
        .song-card { display: flex; align-items: center; padding: 15px; background: var(--bg-card); border-radius: 8px; margin-bottom: 10px; gap: 15px; transition: background-color 0.2s; }
        .song-card:hover { background: #3e3e3e; }
        .song-card-image { width: 60px; height: 60px; border-radius: 6px; object-fit: cover; }
        .song-info { flex: 1; min-width: 0; }
        .song-title { font-weight: 600; }
        .song-artist { color: var(--text-light); font-size: 0.9em; }

        /* --- Buttons --- */
        .btn { padding: 12px 24px; background: var(--primary-color); color: var(--bg-dark); border: none; border-radius: 500px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; text-transform: uppercase; }
        .btn:hover { background: var(--secondary-color); transform: scale(1.05); }
        .btn-secondary { background: transparent; color: white; border: 1px solid #4f4f4f; text-transform: none; font-weight: 500; }
        .btn-secondary:hover { background: var(--bg-card); border-color: var(--primary-color); color: var(--primary-color); }
        
        /* --- Customization & Controls --- */
        .control-group { margin-bottom: 20px; }
        .control-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .slider { width: 100%; height: 6px; border-radius: 3px; background: #535353; outline: none; -webkit-appearance: none; transition: background 0.2s; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); cursor: pointer; transition: transform 0.2s; }
        .slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .slider-value { margin-left: 10px; color: var(--primary-color); font-weight: 600; }
        .radio-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .radio-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .feature-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; padding: 15px; background: var(--bg-card); border-radius: 8px; margin-bottom: 20px; }
        .feature-checkbox { display: flex; align-items: center; gap: 8px; }
        .feature-checkbox input { accent-color: var(--primary-color); width: 18px; height: 18px; }
        
        /* --- Expandable Sections --- */
        .expandable-section { margin-top: 20px; background: var(--bg-card); border-radius: 8px; overflow: hidden; }
        .expandable-header { width: 100%; text-align: left; padding: 15px 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: transparent; border: 1px solid #3e3e3e; color: white; transition: all 0.2s; }
        .large-expandable-btn { padding: 20px 30px; font-size: 1.1em; font-weight: 500; background: #2a2a2a; border: 2px solid #3e3e3e; }
        .expandable-header:hover, .large-expandable-btn:hover { background: #3e3e3e; border-color: var(--primary-color); }
        .expandable-content { display: none; padding: 20px; border-top: 1px solid #3e3e3e; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .expandable-icon { transition: transform 0.3s; }
        .expandable-icon.rotated { transform: rotate(180deg); }
        .profile-sliders { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* --- Recommendation Display --- */
        .recommendations-grid { display: grid; gap: 15px; }
        /* **STYLE UPDATE:** Increased padding and icon size for a larger feel */
        .recommendation-card { display: flex; align-items: center; padding: 15px; background: var(--bg-card); border-radius: 8px; transition: all 0.3s; gap: 15px; }
        .recommendation-card:hover { background: #3e3e3e; transform: scale(1.02); }
        .recommendation-album-art { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
        .recommendation-rank { font-size: 2em; font-weight: 700; color: var(--primary-color); opacity: 0.3; min-width: 40px; }
        .recommendation-info { flex: 1; min-width: 0; }
        .recommendation-actions { display: flex; gap: 10px; align-items: center; }
        /* **STYLE UPDATE:** Made play icon larger */
        .icon-btn { width: 44px; height: 44px; font-size: 20px; border-radius: 50%; border: none; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-light); flex-shrink: 0; transition: all 0.2s; }
        .icon-btn:hover { background: #535353; color: white; }
        .distance-badge { background: var(--primary-color); color: var(--bg-dark); padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        
        /* --- Floating Panel & Player --- */
        .floating-panel { position: fixed; right: -400px; top: 80px; width: 380px; max-height: calc(100vh - 180px); background: #fdfdfd; border-radius: 12px 0 0 12px; box-shadow: -4px 0 20px rgba(0,0,0,0.2); transition: right 0.3s ease; z-index: 1000; display: flex; flex-direction: column; color: var(--text-dark); }
        .floating-panel.active { right: 0; }
        .floating-panel-header { padding: 20px; background: var(--primary-color); color: var(--bg-dark); display: flex; justify-content: space-between; align-items: center; }
        .floating-panel-title { font-size: 1.2em; font-weight: 600; }
        .close-panel { background: rgba(0,0,0,0.2); border: none; color: var(--bg-dark); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }
        .close-panel:hover { background: rgba(0,0,0,0.3); }
        .floating-panel-content { flex: 1; overflow-y: auto; padding: 20px; }
        .mini-player { padding: 15px; background: #f3f4f6; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; border: 1px solid #e5e7eb; }
        .mini-player-image { width: 60px; height: 60px; border-radius: 6px; object-fit: cover; }
        .mini-player-info { flex: 1; }
        .mini-player-title { font-weight: 600; margin-bottom: 2px; }
        .mini-player-artist { color: #4b5563; font-size: 0.9em; }
        .quick-recommendation { padding: 12px; background: var(--bg-white); border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; border: 1px solid #e5e7eb; }
        .quick-recommendation:hover { background: #f9fafb; transform: translateX(-5px); border-color: var(--primary-color); }
        .quick-recommendation-image { width: 48px; height: 48px; border-radius: 4px; object-fit: cover; flex-shrink: 0; }
        .quick-recommendation-info { flex: 1; min-width: 0; }
        .quick-recommendation-info .song-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .quick-recommendation-info .song-artist { color: #6b7280; font-size: 0.85em; }
        .quick-recommendation .btn-secondary { color: #4b5563; border-color: #d1d5db; background-color: #f9fafb; padding: 8px 16px; font-size: 14px; }
        .music-player-bar { position: fixed; bottom: -100px; left: 0; width: 100%; height: 80px; background: #282828; border-top: 1px solid #404040; display: flex; align-items: center; padding: 0 20px; z-index: 1001; transition: bottom 0.3s ease-in-out; }
        .music-player-bar.visible { bottom: 0; }
        .player-song-info { display: flex; align-items: center; gap: 15px; width: 30%; min-width: 0; }
        .player-album-art { width: 50px; height: 50px; border-radius: 4px; }
        .player-track-details {min-width: 0;}
        .player-track-details .title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .player-track-details .artist { color: var(--text-light); font-size: 0.9em; }
        .player-controls { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 40%; flex-grow: 1; }
        .player-buttons { display: flex; align-items: center; gap: 20px; }
        .player-buttons .play-pause-btn { width: 40px; height: 40px; border-radius: 50%; background: white; color: black; font-size: 20px; border: none; cursor: pointer; }
        .player-progress-container { display: flex; align-items: center; gap: 10px; width: 100%; font-size: 0.8em; margin-top: 5px; }
        .progress-bar { flex-grow: 1; height: 4px; background: #535353; border-radius: 2px; cursor: pointer; }
        .progress-bar-filled { height: 100%; width: 0%; background: var(--primary-color); border-radius: 2px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; margin: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- Footer --- */
        .footer { background: #191414; margin-top: 80px; padding: 50px 0; }
        .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 40px; }
        .footer-section h3 { font-size: 1.2em; margin-bottom: 15px; }
        .footer-section p { color: rgba(255,255,255,0.8); line-height: 1.8; margin-bottom: 10px; }
        .footer-section a { color: var(--primary-color); text-decoration: none; }
        .footer-links { list-style: none; padding: 0; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: rgba(255,255,255,0.8); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .footer-links a:hover { color: white; }
        .footer-bottom { margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; color: rgba(255,255,255,0.6); }
        .icon-svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; }
        
        /* --- Responsive --- */
        @media (max-width: 768px) { .profile-sliders { grid-template-columns: 1fr; } .footer-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="#" class="navbar-brand">
                 <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="15" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 10C12 9.44772 12.4477 9 13 9H14C14.5523 9 15 9.44772 15 10V22C15 22.5523 14.5523 23 14 23H13C12.4477 23 12 22.5523 12 22V10Z" fill="currentColor"/>
                    <path d="M17 7C17 6.44772 17.4477 6 18 6H19C19.5523 6 20 6.44772 20 7V25C20 25.5523 19.5523 26 19 26H18C17.4477 26 17 25.5523 17 25V7Z" fill="currentColor"/>
                    <path d="M22 12C22 11.4477 22.4477 11 23 11H24C24.5523 11 25 11.4477 25 12V20C25 20.5523 24.5523 21 24 21H23C22.4477 21 22 20.5523 22 20V12Z" fill="currentColor"/>
                    <path d="M7 14C7 13.4477 7.44772 13 8 13H9C9.55228 13 10 13.4477 10 14V18C10 18.5523 9.55228 19 9 19H8C7.44772 19 7 18.5523 7 18V14Z" fill="currentColor"/>
                </svg>
                <span>K-NN Music Recommender</span>
            </a>
            <div class="navbar-links">
                <a href="#featured" onclick="scrollToSection(event, 'featured')">Featured</a>
                <a href="#search" onclick="scrollToSection(event, 'search')">Search</a>
                <a href="#profile" onclick="scrollToSection(event, 'profile')">Personalize</a>
                <a href="#about" onclick="scrollToSection(event, 'about')">About</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>K-NN Music Recommender</h1>
            <p>Interactive demo of the K-Nearest Neighbors algorithm for music recommendation</p>
        </header>
        
        <!-- Intro Section -->
        <div class="intro-section">
             <h3>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;"><path d="M9 3L5 7M5 7L9 11M5 7H13C16.866 7 20 10.134 20 14C20 17.866 16.866 21 13 21H11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Discover Music Like Never Before
            </h3>
             <p>Ever wondered how Spotify knows what you want to hear next? This demo uses the K-NN algorithm to show you how it works. Search for any song, tweak the dials, and watch as the algorithm finds your next favorite track.</p>
        </div>

        <!-- Featured Section -->
        <section class="section" id="featured">
            <h2 class="section-title">Start Exploring
                <span class="info-icon">?
                    <span class="tooltip">Click any album to play a preview and get instant recommendations in the side panel.</span>
                </span>
            </h2>
            <div class="featured-grid" id="featuredMusic"><div class="loading"></div></div>
        </section>

        <!-- Search Section -->
        <section class="section" id="search">
            <h2 class="section-title">Find Your Seed Song
                <span class="info-icon">?
                    <span class="tooltip">Your seed song is the starting point. The algorithm finds songs with similar audio DNA – energy, mood, tempo, and more.</span>
                </span>
            </h2>
             <div style="background: rgba(29, 185, 84, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(29, 185, 84, 0.3);">
                <h4 style="color: var(--primary-color); margin-bottom: 10px;">Quick Tips:</h4>
                <ul style="list-style: none; padding: 0; color: rgba(255,255,255,0.8); font-size: 0.9em;">
                    <li>&bull; Type naturally: "Imagine John Lennon" or "Queen Bohemian"</li>
                    <li>&bull; Artist only works too: "Taylor Swift" or "The Beatles"</li>
                </ul>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by song or artist..." onkeypress="if(event.key === 'Enter') searchSongs()">
                <button class="btn" onclick="searchSongs()">Search</button>
            </div>
            <div id="searchResults"></div>
            <div id="selectedSong" style="display: none;">
                <h3 style="margin: 20px 0 10px;">Selected Song:</h3>
                <div id="selectedSongCard"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" style="font-size: 1.2em; padding: 16px 40px;" onclick="getSongRecommendations()">Get AI Recommendations</button>
                </div>
                <div id="recommendationsList" class="recommendations-grid" style="margin-top: 30px;"></div>
            </div>
        </section>

        <!-- Personalization Section -->
        <section class="section" id="profile">
            <h2 class="section-title">Personalize Your Discovery
                 <span class="info-icon">?
                    <span class="tooltip">Two ways to personalize: Create a custom search by adjusting audio features, or dive deep into the algorithm settings to control how similarity is calculated.</span>
                </span>
            </h2>
            <div class="expandable-section">
                <button class="expandable-header large-expandable-btn" onclick="toggleProfileBuilder()">
                    <span>Create Your Sound Profile</span>
                    <span id="profileToggleIcon" class="expandable-icon">&#9660;</span>
                </button>
                <div id="profileBuilder" class="expandable-content">
                    <p>Adjust the sliders to match the vibe you're looking for, then get recommendations based on your custom profile.</p>
                    <div class="profile-sliders" id="profileSlidersContainer"></div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="getProfileRecommendations()" style="font-size: 1.1em; padding: 14px 32px;">Find Songs With This Vibe</button>
                    </div>
                </div>
            </div>
            <div class="expandable-section" style="margin-top: 20px;">
                <button class="expandable-header large-expandable-btn" onclick="toggleAlgorithmSettings()">
                    <span>Advanced Algorithm Settings</span>
                    <span id="algorithmToggleIcon" class="expandable-icon">&#9660;</span>
                </button>
                <div id="algorithmSettings" class="expandable-content">
                    <div class="control-group">
                        <label class="control-label">Feature Selection:</label>
                        <div class="feature-selection" id="featureSelectionContainer"></div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Number of Neighbors (k): <span class="slider-value" id="globalKValue">10</span></label>
                        <input type="range" class="slider" id="globalKSlider" min="1" max="50" value="10" oninput="updateGlobalKValue(this.value)">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Distance Metric:</label>
                        <div class="radio-group">
                            <label class="radio-label"><input type="radio" name="globalDistance" value="cosine" checked onchange="updateGlobalDistanceMetric()"> Cosine</label>
                            <label class="radio-label"><input type="radio" name="globalDistance" value="euclidean" onchange="updateGlobalDistanceMetric()"> Euclidean</label>
                            <label class="radio-label"><input type="radio" name="globalDistance" value="manhattan" onchange="updateGlobalDistanceMetric()"> Manhattan</label>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="applyGlobalSettings(this)">Apply Global Settings</button>
                    </div>
                </div>
            </div>
            <div id="profileRecommendations" class="recommendations-grid" style="margin-top: 30px;"></div>
        </section>
    </div>

    <!-- Floating Side Panel for Quick Recs -->
    <div class="floating-panel" id="floatingPanel"></div>
    
    <!-- Music Player Bar -->
    <div class="music-player-bar" id="musicPlayerBar"></div>
    
    <!-- Footer -->
    <footer class="footer" id="about">
         <div class="footer-content">
            <div class="footer-section">
                <h3>About This Project</h3>
                <p>Built for <strong>ECE4424/CS4824: Machine Learning</strong> at Virginia Tech, this project brings the K-NN algorithm to life through music. It's designed to be both educational and fun to use.</p>
                <p>Course instructor: <a href="https://jinming99.github.io" target="_blank" rel="noopener noreferrer">Dr. Ming Jin</a></p>
            </div>
            <div class="footer-section">
                <h3>Resources</h3>
                <ul class="footer-links">
                    <li><a href="https://jinming99.github.io/learn-ml-by-building/" target="_blank" rel="noopener noreferrer"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg> Course Materials</a></li>
                    <li><a href="https://github.com/vraj152/RUMusic" target="_blank" rel="noopener noreferrer"><svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg> See the Code</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Under the Hood</h3>
                <ul class="footer-links">
                    <li>K-Nearest Neighbors</li>
                    <li>Python + Flask</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom"><p>&copy; 2025 Virginia Tech</p></div>
    </footer>

    <script>
        const API_BASE = '/api'; // Use relative path for production
        let currentAudio = null;
        let currentPlayToken = 0; // increments on each play request to avoid async races
        let selectedSong = null;
        let userProfile = {};
        let globalAlgorithmSettings = { k: 10, metric: 'cosine', features: [] };
        const ALL_FEATURES = [
            { id: 'energy', name: 'Energy', isBpm: false, min: 0, max: 1, step: 0.05, value: 0.5 },
            { id: 'danceability', name: 'Danceability', isBpm: false, min: 0, max: 1, step: 0.05, value: 0.5 },
            { id: 'acousticness', name: 'Acousticness', isBpm: false, min: 0, max: 1, step: 0.05, value: 0.5 },
            { id: 'valence', name: 'Valence (Mood)', isBpm: false, min: 0, max: 1, step: 0.05, value: 0.5 },
            { id: 'tempo', name: 'Tempo', isBpm: true, min: 60, max: 200, step: 5, value: 120 },
            { id: 'instrumentalness', name: 'Instrumentalness', isBpm: false, min: 0, max: 1, step: 0.05, value: 0.5 },
        ];
        
        const playerBar = document.getElementById('musicPlayerBar');
        const floatingPanel = document.getElementById('floatingPanel');
        
        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            loadFeaturedMusic();
            populateDynamicControls();
            setupPlayer();
        });

        function populateDynamicControls() {
            const profileContainer = document.getElementById('profileSlidersContainer');
            const featureContainer = document.getElementById('featureSelectionContainer');
            
            let profileHtml = '';
            let featureHtml = '';
            
            ALL_FEATURES.forEach(f => {
                userProfile[f.id] = f.value;
                profileHtml += `
                    <div class="control-group">
                        <label class="control-label">${f.name}: <span class="slider-value" id="profile${f.id}">${f.value}</span> ${f.isBpm ? 'BPM' : ''}</label>
                        <input type="range" class="slider" id="${f.id}ProfileSlider" min="${f.min}" max="${f.max}" step="${f.step}" value="${f.value}" oninput="updateProfileValue('${f.id}', this.value)">
                    </div>`;
                featureHtml += `
                    <label class="feature-checkbox">
                        <input type="checkbox" id="global_feature_${f.id}" checked onchange="updateGlobalFeatureSelection()"> ${f.name}
                    </label>`;
            });
            
            profileContainer.innerHTML = profileHtml;
            featureContainer.innerHTML = featureHtml;
            updateGlobalFeatureSelection();
        }
        
        function setupPlayer() {
             playerBar.innerHTML = `
                <div class="player-song-info">
                    <img src="https://placehold.co/50x50/121212/121212?text=." alt="" class="player-album-art">
                    <div class="player-track-details"><div class="title"></div><div class="artist"></div></div>
                </div>
                <div class="player-controls">
                    <div class="player-buttons"><button class="play-pause-btn">&#9654;</button></div>
                    <div class="player-progress-container">
                        <span class="current-time">0:00</span>
                        <div class="progress-bar"><div class="progress-bar-filled"></div></div>
                        <span class="duration">0:00</span>
                    </div>
                </div>
                <div style="width: 30%;"></div>`; // Spacer
            playerBar.querySelector('.play-pause-btn').addEventListener('click', togglePlayPause);
            playerBar.querySelector('.progress-bar').addEventListener('click', seek);
        }

        // --- API & Data Fetching ---
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP error! Status: ${response.status}` }));
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                console.error("API Call Error:", error);
                showToast(error.message, 'error');
                return { success: false, data: {}, error: error.message };
            }
        }
        
        async function loadFeaturedMusic() {
            const result = await apiCall('/featured');
            if (result.success) displayFeaturedMusic(Object.values(result.data));
            else document.getElementById('featuredMusic').innerHTML = '<p>Could not load featured music.</p>';
        }

        async function searchSongs() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            document.getElementById('searchResults').innerHTML = '<div class="loading"></div>';
            document.getElementById('selectedSong').style.display = 'none';
            document.getElementById('recommendationsList').innerHTML = '';
            const result = await apiCall(`/search?song_name=${encodeURIComponent(query)}`);
            if (result.success) displaySearchResults(Object.values(result.data));
        }

        async function getSongRecommendations() {
            if (!selectedSong) return;
            const container = document.getElementById('recommendationsList');
            container.innerHTML = '<div class="loading"></div>';
            const params = new URLSearchParams({ k: globalAlgorithmSettings.k, metric: globalAlgorithmSettings.metric, features: globalAlgorithmSettings.features.join(',') });
            const result = await apiCall(`/recommend/track/${selectedSong.id}?${params}`);
            if (result.success) {
                displayRecommendations(Object.values(result.data), 'recommendationsList');
            } else {
                container.innerHTML = `<p style="text-align:center; color:#f15e6c;">${result.error || 'Could not load recommendations.'}</p>`;
            }
        }
        
        async function getProfileRecommendations() {
            const container = document.getElementById('profileRecommendations');
            container.innerHTML = '<div class="loading"></div>';
            const payload = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    features: userProfile,
                    k: globalAlgorithmSettings.k,
                    distance_metric: globalAlgorithmSettings.metric,
                    selected_features: globalAlgorithmSettings.features
                })
            };
            const result = await apiCall('/recommend/profile', payload);
            if (result.success) {
                displayRecommendations(Object.values(result.data), 'profileRecommendations');
            } else {
                container.innerHTML = `<p style="text-align:center; color:#f15e6c;">${result.error || 'This feature is not implemented yet.'}</p>`;
            }
        }

        // --- UI Rendering ---
        function displayFeaturedMusic(songs) {
            document.getElementById('featuredMusic').innerHTML = songs.map(song => `
                <div class="music-card" onclick='handleSongClick(${JSON.stringify(song)})'>
                    <img src="${song.albumart || 'https://placehold.co/300x300'}" alt="${escapeHtml(song.song)}" class="music-card-image" onerror="this.onerror=null;this.src='https://placehold.co/300x300/181818/fff?text=Error';">
                    <div class="play-button">&#9654;</div>
                    <div class="music-card-overlay">
                        <div class="music-card-title">${escapeHtml(song.song)}</div>
                        <div class="music-card-artist">${escapeHtml(song.artist)}</div>
                    </div>
                </div>`).join('');
        }
        
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            if (!results || results.length === 0) {
                container.innerHTML = '<p style="text-align: center;">No results found.</p>'; return;
            }
            container.innerHTML = results.map(song => `
                <div class="song-card">
                    <img src="${song.albumart || 'https://placehold.co/60x60'}" alt="${escapeHtml(song.song)}" class="song-card-image" onerror="this.onerror=null;this.src='https://placehold.co/60x60';">
                    <div class="song-info">
                        <div class="song-title">${escapeHtml(song.song)}</div>
                        <div class="song-artist">${escapeHtml(song.artist)}</div>
                    </div>
                    <button class="btn btn-secondary" onclick='selectSong(${JSON.stringify(song)})'>Select as Seed</button>
                </div>`).join('');
        }

        function displayRecommendations(recs, containerId) {
            const container = document.getElementById(containerId);
            container.style.display = 'grid';
            container.innerHTML = recs.length ? recs.map((rec, i) => `
                <div class="recommendation-card">
                    <div class="recommendation-rank">${i + 1}</div>
                    <img src="${rec.albumart || 'https://placehold.co/80x80'}" alt="${escapeHtml(rec.song)}" class="recommendation-album-art" onerror="this.onerror=null;this.src='https://placehold.co/80x80';">
                    <div class="recommendation-info">
                        <div class="song-title">${escapeHtml(rec.song)}</div>
                        <div class="song-artist">${escapeHtml(rec.artist)}</div>
                        <span class="distance-badge">Similarity: ${((rec.similarity_score || 0) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="recommendation-actions">
                        <button class="icon-btn" onclick='handleSongClick(${JSON.stringify(rec)})' title="Play">&#9654;</button>
                    </div>
                </div>`).join('') : '<p>No recommendations found for this query.</p>';
        }

        // --- User Actions & Event Handlers ---
        function handleSongClick(song) {
            playSong(song);
            openQuickRecsPanel(song);
        }

        function selectSong(song) {
            selectedSong = song;
            document.getElementById('selectedSong').style.display = 'block';
            document.getElementById('selectedSongCard').innerHTML = `
                <div class="song-card" style="background: #3e3e3e; border: 1px solid var(--primary-color);">
                    <img src="${song.albumart}" alt="${escapeHtml(song.song)}" class="song-card-image" onerror="this.onerror=null;this.src='https://placehold.co/60x60';">
                    <div class="song-info">
                        <div class="song-title">${escapeHtml(song.song)}</div>
                        <div class="song-artist">${escapeHtml(song.artist)}</div>
                    </div>
                </div>`;
            document.getElementById('recommendationsList').innerHTML = '';
            scrollToSection(null, 'selectedSong');
        }
        
        // --- Floating Panel ---
        async function openQuickRecsPanel(song) {
            floatingPanel.innerHTML = `
                <div class="floating-panel-header"><div class="floating-panel-title">Quick Recommendations</div><button class="close-panel" onclick="closeFloatingPanel()">&#10005;</button></div>
                <div class="floating-panel-content">
                    <div class="mini-player"><img src="${song.albumart}" alt="${escapeHtml(song.song)}" class="mini-player-image" onerror="this.onerror=null;this.src='https://placehold.co/60x60';"><div class="mini-player-info"><div class="mini-player-title">${escapeHtml(song.song)}</div><div class="mini-player-artist">${escapeHtml(song.artist)}</div></div></div>
                    <h4 style="margin-bottom: 15px;">Similar Songs</h4><div id="quickRecommendations"><div class="loading"></div></div>
                </div>`;
            floatingPanel.classList.add('active');

            const params = new URLSearchParams({ k: 5, metric: globalAlgorithmSettings.metric, features: globalAlgorithmSettings.features.join(',') });
            const result = await apiCall(`/recommend/track/${song.id}?${params}`);
            
            if (result.success) {
                document.getElementById('quickRecommendations').innerHTML = Object.values(result.data).map(rec => `
                    <div class="quick-recommendation">
                        <img src="${rec.albumart}" alt="${escapeHtml(rec.song)}" class="quick-recommendation-image" onerror="this.onerror=null;this.src='https://placehold.co/48x48';">
                        <div class="quick-recommendation-info"><div class="song-title">${escapeHtml(rec.song)}</div><div class="song-artist">${escapeHtml(rec.artist)}</div></div>
                        <div class="recommendation-actions">
                            <button class="icon-btn" onclick='handleSongClick(${JSON.stringify(rec)})' title="Play">&#9654;</button>
                            <button class="btn btn-secondary" onclick='selectSong(${JSON.stringify(rec)}); closeFloatingPanel();' title="Select as Seed">Seed</button>
                        </div>
                    </div>`).join('');
            } else {
                 document.getElementById('quickRecommendations').innerHTML = "<p>Could not load recommendations.</p>";
            }
        }
        function closeFloatingPanel() { floatingPanel.classList.remove('active'); }
        
        // --- Music Player Logic ---
        async function playSong(song) {
            // create a new play session token
            const token = ++currentPlayToken;

            // stop any currently playing audio immediately
            if (currentAudio) {
                try { currentAudio.pause(); } catch (_) {}
            }

            playerBar.classList.add('visible');
            updatePlayerUI(song, true);

            // fetch audio url
            const result = await apiCall(`/getmp3url?songid=${song.id}`);

            // if another play request started since we awaited, abort this one
            if (token !== currentPlayToken) return;

            if (result.success && result.url) {
                const audio = new Audio(result.url);

                // if token became stale before wiring listeners, abort
                if (token !== currentPlayToken) { try { audio.pause(); } catch (_) {} return; }

                audio.addEventListener('loadedmetadata', () => {
                    if (token !== currentPlayToken) return;
                    playerBar.querySelector('.duration').textContent = formatTime(audio.duration);
                });
                audio.addEventListener('timeupdate', () => {
                    if (token !== currentPlayToken) return;
                    updateProgress();
                });
                audio.addEventListener('ended', () => {
                    if (token !== currentPlayToken) return;
                    playerBar.querySelector('.play-pause-btn').innerHTML = '&#9654;';
                });

                currentAudio = audio;
                audio.play().then(() => {
                    if (token !== currentPlayToken) { try { audio.pause(); } catch (_) {} }
                }).catch(e => {
                    showToast(`Playback error: ${e.message}`, 'error');
                    updatePlayerUI(song, false, true); // Update UI to show paused state on error
                });
                updatePlayerUI(song, false);
            } else {
                showToast(`Could not find audio for "${song.song}"`, 'error');
                updatePlayerUI(song, false, true); // Update UI but show paused
            }
        }

        function togglePlayPause() {
            if (!currentAudio || !currentAudio.src) return;
            const btn = playerBar.querySelector('.play-pause-btn');
            if (currentAudio.paused) { currentAudio.play(); btn.innerHTML = '&#10074;&#10074;'; }
            else { currentAudio.pause(); btn.innerHTML = '&#9654;'; }
        }

        function updatePlayerUI(song, isLoading, isPaused = false) {
            const [titleEl, artistEl, artEl, btn] = ['.title', '.artist', '.player-album-art', '.play-pause-btn'].map(sel => playerBar.querySelector(sel));
            titleEl.textContent = isLoading ? "Loading..." : song.song;
            artistEl.textContent = isLoading ? "" : song.artist;
            artEl.src = song.albumart || 'https://placehold.co/50x50';
            btn.innerHTML = isLoading ? '...' : (isPaused ? '&#9654;' : '&#10074;&#10074;');
        }

        function updateProgress() {
            if (!currentAudio || !currentAudio.duration) return;
            const currentTimeEl = playerBar.querySelector('.current-time');
            const progressBarFilled = playerBar.querySelector('.progress-bar-filled');
            currentTimeEl.textContent = formatTime(currentAudio.currentTime);
            progressBarFilled.style.width = `${(currentAudio.currentTime / currentAudio.duration) * 100}%`;
        }

        function seek(e) {
            if (!currentAudio || !currentAudio.duration) return;
            const progressBar = playerBar.querySelector('.progress-bar');
            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            currentAudio.currentTime = percent * currentAudio.duration;
        }

        // --- Settings & UI Toggles ---
        function updateProfileValue(feature, value) {
            const f = ALL_FEATURES.find(f => f.id === feature);
            document.getElementById(`profile${feature}`).textContent = f.isBpm ? Math.round(value) : value;
            userProfile[feature] = parseFloat(value);
        }
        function updateGlobalKValue(value) {
            globalAlgorithmSettings.k = parseInt(value, 10);
            document.getElementById('globalKValue').textContent = value;
        }
        function updateGlobalDistanceMetric() { globalAlgorithmSettings.metric = document.querySelector('input[name="globalDistance"]:checked').value; }
        function updateGlobalFeatureSelection() { globalAlgorithmSettings.features = Array.from(document.querySelectorAll('#featureSelectionContainer input:checked')).map(cb => cb.id.replace('global_feature_', '')); }
        function formatTime(seconds) { const m = Math.floor(seconds / 60), s = Math.floor(seconds % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; }
        function escapeHtml(unsafe) { return unsafe?.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") || ''; }
        function scrollToSection(e, id) { if(e) e.preventDefault(); document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        
        function showToast(message, type = 'success') {
            let toast = document.createElement('div');
            toast.textContent = message;
            Object.assign(toast.style, { 
                position: 'fixed', bottom: '100px', left: '50%', transform: 'translateX(-50%)', 
                background: type === 'error' ? 'var(--error-color)' : 'var(--success-color)', 
                color: 'white', padding: '12px 24px', borderRadius: '8px', zIndex: '2000',
                boxShadow: '0 4px 12px rgba(0,0,0,0.2)', transition: 'opacity 0.3s, bottom 0.3s',
                opacity: '0',
            });
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.bottom = '110px';
            }, 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.bottom = '100px';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleSection(contentEl, iconEl) { 
            const isVisible = contentEl.style.display === 'block'; 
            contentEl.style.display = isVisible ? 'none' : 'block'; 
            iconEl.classList.toggle('rotated', !isVisible); 
        }
        function toggleProfileBuilder() { toggleSection(document.getElementById('profileBuilder'), document.getElementById('profileToggleIcon')); }
        function toggleAlgorithmSettings() { toggleSection(document.getElementById('algorithmSettings'), document.getElementById('algorithmToggleIcon')); }
        
        function applyGlobalSettings(btn) {
            const originalText = btn.textContent;
            btn.textContent = '✓ Settings Applied!';
            btn.style.background = 'var(--success-color)';
            showToast('Global algorithm settings updated.');
            setTimeout(() => { 
                btn.textContent = originalText; 
                btn.style.background = ''; 
            }, 1500);
        }
    </script>
</body>
</html>
